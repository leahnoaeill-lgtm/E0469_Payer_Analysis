<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E0469 Coverage Heatmap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        header { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 20px 30px; }
        header h1 { font-size: 1.8em; }
        header p { opacity: 0.9; margin-top: 5px; }
        .nav-link { color: white; text-decoration: none; opacity: 0.8; font-size: 0.9em; }
        .nav-link:hover { opacity: 1; text-decoration: underline; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .legend { display: flex; gap: 20px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid #ccc; }
        .content-row { display: flex; gap: 20px; }
        .map-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 2; }
        .detail-panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; min-width: 300px; }
        #us-map { width: 100%; height: 500px; }
        #us-map path { stroke: #fff; stroke-width: 1; cursor: pointer; transition: opacity 0.2s, stroke-width 0.2s; }
        #us-map path:hover { opacity: 0.8; }
        #us-map path.selected { stroke: #1a365d; stroke-width: 3; }
        .stats-row { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { background: white; padding: 15px 25px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-box .value { font-size: 1.8em; font-weight: 700; }
        .stat-box .label { font-size: 0.85em; color: #64748b; }
        .stat-box.covered .value { color: #059669; }
        .stat-box.prior-auth .value { color: #2563eb; }
        .stat-box.not-covered .value { color: #dc2626; }
        .stat-box.no-data .value { color: #64748b; }
        .detail-panel h2 { color: #1a365d; margin-bottom: 15px; font-size: 1.2em; }
        .detail-panel .placeholder { color: #64748b; font-style: italic; }
        .state-name { font-size: 1.5em; font-weight: 700; color: #1a365d; margin-bottom: 10px; }
        .status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-weight: 600; margin-bottom: 15px; }
        .status-badge.covered { background: #C6EFCE; color: #166534; }
        .status-badge.prior-auth { background: #BDD7EE; color: #1e40af; }
        .status-badge.not-covered { background: #FFC7CE; color: #991b1b; }
        .status-badge.no-data { background: #E2E8F0; color: #64748b; }
        .payer-list { margin-top: 15px; }
        .payer-list h3 { font-size: 0.9em; color: #64748b; margin-bottom: 10px; text-transform: uppercase; }
        .payer-item { padding: 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; }
        .status-section { margin-bottom: 20px; }
        .status-section .status-badge { margin-bottom: 10px; }
        .payer-sublist { margin-top: 10px; }
        .total-payers { color: #64748b; margin-bottom: 15px; font-size: 0.95em; }
        .loading { text-align: center; padding: 40px; color: #64748b; }
        @media (max-width: 900px) { .content-row { flex-direction: column; } }
    </style>
</head>
<body>
    <header>
        <p><a href="/" class="nav-link">‚Üê Back to Dashboard</a></p>
        <h1>E0469 Coverage Heatmap by State</h1>
        <p>Click a state to see payer details</p>
    </header>

    <div class="container">
        <div class="stats-row">
            <div class="stat-box covered"><div class="value" id="coveredCount">-</div><div class="label">States Covered</div></div>
            <div class="stat-box prior-auth"><div class="value" id="priorAuthCount">-</div><div class="label">States Prior-Auth</div></div>
            <div class="stat-box not-covered"><div class="value" id="notCoveredCount">-</div><div class="label">States Not Covered</div></div>
            <div class="stat-box no-data"><div class="value" id="noDataCount">-</div><div class="label">No Policy Found</div></div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: #C6EFCE;"></div><span>Covered</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #BDD7EE;"></div><span>Prior-Auth Required</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #FFC7CE;"></div><span>Not Covered</span></div>
            <div class="legend-item"><div class="legend-color" style="background: repeating-linear-gradient(45deg, #C6EFCE, #C6EFCE 4px, #BDD7EE 4px, #BDD7EE 8px);"></div><span>Mixed (striped)</span></div>
            <div class="legend-item"><div class="legend-color" style="background: #E2E8F0;"></div><span>No Policy Found</span></div>
        </div>

        <div class="content-row">
            <div class="map-container">
                <svg id="us-map">
                    <defs>
                        <!-- Stripe patterns for mixed statuses -->
                        <pattern id="pattern-covered-priorauth" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                            <rect width="4" height="8" fill="#C6EFCE"/>
                            <rect x="4" width="4" height="8" fill="#BDD7EE"/>
                        </pattern>
                        <pattern id="pattern-covered-notcovered" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                            <rect width="4" height="8" fill="#C6EFCE"/>
                            <rect x="4" width="4" height="8" fill="#FFC7CE"/>
                        </pattern>
                        <pattern id="pattern-priorauth-notcovered" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                            <rect width="4" height="8" fill="#BDD7EE"/>
                            <rect x="4" width="4" height="8" fill="#FFC7CE"/>
                        </pattern>
                        <pattern id="pattern-all-three" patternUnits="userSpaceOnUse" width="12" height="8" patternTransform="rotate(45)">
                            <rect width="4" height="8" fill="#C6EFCE"/>
                            <rect x="4" width="4" height="8" fill="#BDD7EE"/>
                            <rect x="8" width="4" height="8" fill="#FFC7CE"/>
                        </pattern>
                    </defs>
                </svg>
            </div>
            <div class="detail-panel">
                <h2>State Details</h2>
                <div id="stateDetails"><p class="placeholder">Click a state on the map to view coverage details</p></div>
            </div>
        </div>
    </div>

    <script>
        const stateData = {};
        const stateNames = {
            AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',CT:'Connecticut',
            DE:'Delaware',DC:'District of Columbia',FL:'Florida',GA:'Georgia',HI:'Hawaii',ID:'Idaho',IL:'Illinois',
            IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',
            MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',
            NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',
            OH:'Ohio',OK:'Oklahoma',OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',
            TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'
        };
        const fipsToAbbr = {'01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE','11':'DC','12':'FL','13':'GA','15':'HI','16':'ID','17':'IL','18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD','25':'MA','26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ','35':'NM','36':'NY','37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC','46':'SD','47':'TN','48':'TX','49':'UT','50':'VT','51':'VA','53':'WA','54':'WV','55':'WI','56':'WY'};

        let selectedState = null;

        function getStateFill(abbr) {
            const data = stateData[abbr];
            if (!data || !data.statuses) return '#E2E8F0'; // No policy found

            const hasCovered = data.statuses['Covered'] > 0;
            const hasPriorAuth = data.statuses['Prior-Auth Required'] > 0;
            const hasNotCovered = data.statuses['Not Covered'] > 0;

            const statusCount = (hasCovered ? 1 : 0) + (hasPriorAuth ? 1 : 0) + (hasNotCovered ? 1 : 0);

            // Single status - solid color
            if (statusCount === 1) {
                if (hasCovered) return '#C6EFCE';
                if (hasPriorAuth) return '#BDD7EE';
                if (hasNotCovered) return '#FFC7CE';
            }

            // Multiple statuses - use stripe pattern
            if (statusCount === 3) return 'url(#pattern-all-three)';
            if (hasCovered && hasPriorAuth) return 'url(#pattern-covered-priorauth)';
            if (hasCovered && hasNotCovered) return 'url(#pattern-covered-notcovered)';
            if (hasPriorAuth && hasNotCovered) return 'url(#pattern-priorauth-notcovered)';

            return '#E2E8F0';
        }

        async function loadMap() {
            try {
                const [us, coverage] = await Promise.all([
                    fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(r => r.json()),
                    fetch('/api/state-coverage').then(r => r.json())
                ]);

                coverage.forEach(item => { stateData[item.state] = item; });

                // Count states by their statuses (a state can have multiple)
                let covered = 0, priorAuth = 0, notCovered = 0;
                coverage.forEach(item => {
                    if (item.statuses) {
                        if (item.statuses['Covered']) covered++;
                        if (item.statuses['Prior-Auth Required']) priorAuth++;
                        if (item.statuses['Not Covered']) notCovered++;
                    }
                });

                document.getElementById('coveredCount').textContent = covered;
                document.getElementById('priorAuthCount').textContent = priorAuth;
                document.getElementById('notCoveredCount').textContent = notCovered;
                document.getElementById('noDataCount').textContent = 50 - coverage.length;

                const states = topojson.feature(us, us.objects.states).features;
                const svg = d3.select('#us-map');
                const width = svg.node().clientWidth || 800;
                const height = 500;
                svg.attr('viewBox', `0 0 ${width} ${height}`);

                const projection = d3.geoAlbersUsa().fitSize([width, height], {type: 'FeatureCollection', features: states});
                const path = d3.geoPath().projection(projection);

                svg.selectAll('path').data(states).enter().append('path')
                    .attr('d', path)
                    .attr('data-state', d => fipsToAbbr[String(d.id).padStart(2,'0')] || '')
                    .attr('fill', d => {
                        const abbr = fipsToAbbr[String(d.id).padStart(2,'0')];
                        return getStateFill(abbr);
                    })
                    .on('click', function(event, d) {
                        const abbr = fipsToAbbr[String(d.id).padStart(2,'0')];
                        selectState(abbr, this);
                    });
            } catch (err) {
                console.error('Error loading map:', err);
                document.getElementById('us-map').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#dc2626">Error loading map. Check console.</text>';
            }
        }

        function selectState(abbr, element) {
            document.querySelectorAll('#us-map path').forEach(p => p.classList.remove('selected'));
            if (element) element.classList.add('selected');
            selectedState = abbr;

            const data = stateData[abbr];
            const name = stateNames[abbr] || abbr;
            const panel = document.getElementById('stateDetails');

            if (!data) {
                panel.innerHTML = `<div class="state-name">${name}</div><span class="status-badge no-data">No Policy Found</span><p>No E0469 policy found for this state.</p>`;
                return;
            }

            // Build status breakdown HTML
            const statusOrder = ['Covered', 'Prior-Auth Required', 'Not Covered'];
            let statusHtml = '';

            statusOrder.forEach(status => {
                if (data.statuses && data.statuses[status]) {
                    const count = data.statuses[status];
                    const payers = data.payers_by_status[status] ? data.payers_by_status[status].split(', ') : [];
                    const statusClass = status === 'Covered' ? 'covered' : status === 'Not Covered' ? 'not-covered' : 'prior-auth';

                    statusHtml += `
                        <div class="status-section">
                            <span class="status-badge ${statusClass}">${status} (${count})</span>
                            <div class="payer-sublist">
                                ${payers.map(p => `<div class="payer-item">${p}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            panel.innerHTML = `
                <div class="state-name">${name}</div>
                <p class="total-payers">Total Payers: ${data.total_payers}</p>
                <div class="payer-list">
                    ${statusHtml}
                </div>
            `;
        }

        loadMap();
    </script>
</body>
</html>
