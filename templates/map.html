<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E0469 Coverage Heatmap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 20px 30px;
        }
        header h1 { font-size: 1.8em; }
        header p { opacity: 0.9; margin-top: 5px; }
        .nav-link {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            font-size: 0.9em;
        }
        .nav-link:hover { opacity: 1; text-decoration: underline; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #us-map { width: 100%; max-width: 1000px; margin: 0 auto; display: block; }
        #us-map path {
            stroke: #fff;
            stroke-width: 1;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #us-map path:hover { opacity: 0.8; }
        .tooltip {
            position: absolute;
            background: #1a365d;
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .tooltip.show { display: block; }
        .tooltip h4 { margin-bottom: 5px; }
        .tooltip p { opacity: 0.9; margin: 2px 0; }
        .stats-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-box .value { font-size: 1.8em; font-weight: 700; }
        .stat-box .label { font-size: 0.85em; color: #64748b; }
        .stat-box.covered .value { color: #059669; }
        .stat-box.prior-auth .value { color: #2563eb; }
        .stat-box.not-covered .value { color: #dc2626; }
        .stat-box.no-data .value { color: #64748b; }
    </style>
</head>
<body>
    <header>
        <p><a href="/" class="nav-link">‚Üê Back to Dashboard</a></p>
        <h1>E0469 Coverage Heatmap by State</h1>
        <p>Geographic view of payer coverage policies</p>
    </header>

    <div class="container">
        <div class="stats-row">
            <div class="stat-box covered">
                <div class="value" id="coveredCount">-</div>
                <div class="label">States Covered</div>
            </div>
            <div class="stat-box prior-auth">
                <div class="value" id="priorAuthCount">-</div>
                <div class="label">States Prior-Auth</div>
            </div>
            <div class="stat-box not-covered">
                <div class="value" id="notCoveredCount">-</div>
                <div class="label">States Not Covered</div>
            </div>
            <div class="stat-box no-data">
                <div class="value" id="noDataCount">-</div>
                <div class="label">No Data</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #C6EFCE;"></div>
                <span>Covered</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BDD7EE;"></div>
                <span>Prior-Auth Required</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFC7CE;"></div>
                <span>Not Covered</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #E2E8F0;"></div>
                <span>No Data</span>
            </div>
        </div>

        <div class="map-container">
            <svg id="us-map" viewBox="0 0 960 600"></svg>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const stateData = {};
        const statePaths = {};

        // State abbreviation to name mapping
        const stateNames = {
            AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',
            CO:'Colorado',CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',
            HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',
            KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',
            MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',
            NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',
            NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',
            OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',
            SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',
            VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'
        };

        async function loadMap() {
            // Load US states GeoJSON
            const geoRes = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
            const us = await geoRes.json();

            // Load coverage data
            const coverageRes = await fetch('/api/state-coverage');
            const coverage = await coverageRes.json();

            coverage.forEach(item => {
                stateData[item.state] = item;
            });

            // Calculate stats
            let covered = 0, priorAuth = 0, notCovered = 0;
            coverage.forEach(item => {
                if (item.coverage_status === 'Covered') covered++;
                else if (item.coverage_status === 'Prior-Auth Required') priorAuth++;
                else if (item.coverage_status === 'Not Covered') notCovered++;
            });

            document.getElementById('coveredCount').textContent = covered;
            document.getElementById('priorAuthCount').textContent = priorAuth;
            document.getElementById('notCoveredCount').textContent = notCovered;
            document.getElementById('noDataCount').textContent = 50 - coverage.length;

            // Render map using TopoJSON
            const states = topojson.feature(us, us.objects.states).features;
            const path = d3.geoPath();

            const svg = d3.select('#us-map');
            svg.selectAll('path')
                .data(states)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('id', d => 'state-' + getStateAbbr(d.id))
                .attr('fill', d => {
                    const abbr = getStateAbbr(d.id);
                    return stateData[abbr] ? stateData[abbr].color : '#E2E8F0';
                })
                .on('mouseover', showTooltip)
                .on('mousemove', moveTooltip)
                .on('mouseout', hideTooltip);
        }

        // FIPS to state abbreviation
        function getStateAbbr(fips) {
            const fipsMap = {
                '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT',
                '10':'DE','11':'DC','12':'FL','13':'GA','15':'HI','16':'ID','17':'IL',
                '18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD',
                '25':'MA','26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE',
                '32':'NV','33':'NH','34':'NJ','35':'NM','36':'NY','37':'NC','38':'ND',
                '39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC','46':'SD',
                '47':'TN','48':'TX','49':'UT','50':'VT','51':'VA','53':'WA','54':'WV',
                '55':'WI','56':'WY'
            };
            return fipsMap[String(fips).padStart(2,'0')] || '';
        }

        function showTooltip(event, d) {
            const abbr = getStateAbbr(d.id);
            const data = stateData[abbr];
            const tooltip = document.getElementById('tooltip');

            let html = `<h4>${stateNames[abbr] || abbr}</h4>`;
            if (data) {
                html += `<p><strong>Status:</strong> ${data.coverage_status}</p>`;
                html += `<p><strong>Payers:</strong> ${data.payer_count}</p>`;
                html += `<p style="font-size:0.8em;opacity:0.8">${data.payers}</p>`;
            } else {
                html += `<p>No coverage data available</p>`;
            }

            tooltip.innerHTML = html;
            tooltip.classList.add('show');
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // Load D3 and TopoJSON libraries
        const d3Script = document.createElement('script');
        d3Script.src = 'https://d3js.org/d3.v7.min.js';
        d3Script.onload = () => {
            const topoScript = document.createElement('script');
            topoScript.src = 'https://cdn.jsdelivr.net/npm/topojson@3';
            topoScript.onload = loadMap;
            document.head.appendChild(topoScript);
        };
        document.head.appendChild(d3Script);
    </script>
</body>
</html>
